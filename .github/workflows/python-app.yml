# GitHub Actions workflow for ansari-whatsapp microservice
# This workflow tests the WhatsApp integration functionality using pytest and TestClient

name: Ansari WhatsApp CICD

on:
  # Trigger the workflow on push or pull request events
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: read

jobs:
  ansari-whatsapp-tests:
    runs-on: ubuntu-latest

    env:
      # Set up environment variables required for testing
      META_WEBHOOK_VERIFY_TOKEN: ${{ secrets.META_WEBHOOK_VERIFY_TOKEN }}
      META_BUSINESS_PHONE_NUMBER_ID: ${{ secrets.META_BUSINESS_PHONE_NUMBER_ID }}
      META_ACCESS_TOKEN_FROM_SYS_USER: ${{ secrets.META_ACCESS_TOKEN_FROM_SYS_USER || 'test-token' }}
      META_WEBHOOK_ZROK_SHARE_TOKEN: ${{ secrets.META_WEBHOOK_ZROK_SHARE_TOKEN || 'test-token' }}
      BACKEND_SERVER_URL: ${{ secrets.BACKEND_SERVER_URL || 'http://localhost:8000' }}
      DEPLOYMENT_TYPE: staging
      HOST: 0.0.0.0
      PORT: 8080
      ORIGINS: "*"
      PYTHONPATH: src:.
      # Enable uv to install packages into system Python (modern approach instead of passing `--system` flag every time)
      UV_SYSTEM_PYTHON: 1

    # Use a Python 3.10 container
    container: python:3.10

    steps:

    # Check out the repository code
    - name: Check out repository code
      uses: actions/checkout@v4

    # Install the uv tool
    - name: Install uv
      run: |
        pip install uv

    # Install Python dependencies using uv
    - name: Install dependencies
      run: |
        # Install the project in editable mode with all dependencies from pyproject.toml
        uv pip install -e .
        # Also ensure test dependencies are installed
        uv pip install pytest pytest-asyncio python-dotenv

    # Run WhatsApp service tests using pytest
    - name: Test with pytest
      run: |
        # Run WhatsApp service tests (no external server dependencies)
        # These test WhatsApp webhook endpoints using TestClient
        pytest tests/test_whatsapp_service.py -v --tb=short

        # Note: WhatsApp API endpoint tests are in ansari-backend repository
        # They test backend API endpoints and use TestClient without external servers

    # Optional: Upload test results as artifacts
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          tests/detailed_test_results_whatsapp_service.json
          tests/test_runner.log
        retention-days: 30